
<html>

<head>

	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700' rel='stylesheet' type='text/css'>
	

	<!-- Load the d3 library. -->
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

</head>
<body>
	<script>
	
	// STATE STUFF
	var statesCSV = []
	/*states = {
		AL: {
			population
			numNewInfected
			numOldInfected
			color	(white)
		}
		...
	}*/
	var states = {};
	d3.csv("2008StatePop.csv", function(data) {
		statesCSV = data;
		statesCSV.forEach(function(s) {
			states[s.Name] = {
				population: s.Population, 
				newInfected: 0,
				oldInfected: 0,
				// total infected is newInfected + oldInfected
				color: 'ffffff'};
		});
	});

	function randomState() {
	    var result;
	    var count = 0;
	    for (var state in states)
	        if (Math.random() < 1/++count)
	           result = state;
	    return result;
	}


	// AIRPORT STUFF
	var airportsCSV = [];
	/*airports = {
		JFK: {
			state = 'NY'
			incoming = 0
			newInfected = 0
			oldInfected
			spreadRatio = 0.0
			latitude = 0.0
			longitude = 0.0
		}
	}*/
	var airports = {};
	d3.csv("airports.csv", function(data) {
		airportsCSV = data;
		airportsCSV.forEach(function(a) {
			airports[a.IATA] = {
				state: a.State, 
				incoming: 0, 
				newInfected: 0,
				oldInfected: 0,
				spreadRatio: 0.0, 
				latitude: a.Latitude, 
				longitude: a.Longitude};
		});
	});


	// FLIGHT STUFF
	var flightsCSV = []
	/*flights = [
		[{src: SRC, dest: DEST, dist: 0}, ...],	day 1
		[{src: SRC, dest: DEST, dist: 0}, ...],	day 2
	]
	Flights only contains one month's worth of data. 
	Day 1 is flights[0]
	}*/
	var flights = [];
	for (var i = 0; i < 31; i++) {
		flights[i] = [];
	}
	d3.csv("2008flights.csv", function(data) {
		flightsCSV = data;
		for (var i = 0; i < flightsCSV.length; i++) {
			f = flightsCSV[i]
			if (f.Cancelled === 1) {
				continue;
			}
			m = parseInt(f.Month);
			if (m === 2) {
				break;
			}
			d = parseInt(f.DayofMonth);
			flights[(d-1)].push({
				src: f.Origin,
				dest: f.Dest,
				dist: f.Distance
			});
		};
	});

	// Assume 100 people on each flight
	// src and dest are objects in airport
	function fly(src, dest) {
		// Get people on plane and to dest airport
		newInfectedProb = states[src.state].newInfected/states[src.state].population
		oldInfectedProb = states[src.state].oldInfected/states[src.state].population
		for (var i = 0; i < 100; i++) {
			r = Math.random();
			if (r < newInfectedProb && states[src.state].newInfected > 0) {
				dest.newInfected += 1
				states[src.state].newInfected -= 1
			} else if (r < newInfectedProb + oldInfectedProb) {
				dest.oldInfected += 1
				states[src.state].oldInfected -= 1
			}
			dest.incoming += 1
			states[src.state].population -= 1
		}
		

	}

	// Data has been collected

	// r0 = # of ppl one sick person will infect on average
	var r0s = {Measles: 18, Mumps: 10, AIDS: 4, SARS: 4, Ebola: 2}

	// ###################################################
	// ##### DROPDOWN MENU FOR USER TO PICK DISEASE ######
	// ###################################################
	var r0 = 'Measles'
	// change r0 to whatever disease user picks

	// #########################################################
	// ##### SIMULATE BUTTON FOR USER TO BEGIN SIMULATION ######
	// #########################################################


	// Disease spread is equal to r0 for each new infective
	// Old infectives no longer infect other people
	

	for (var i = 0; i < 100; i++) {
		states[randomState()].newInfected += 1
	}
	// ################################
	// ##### UPDATE STATE COLORS ######
	// ################################

	
	for day in flights:
		for flight in day:
			// ############################
			// ##### ANIMATE FLIGHT  ######
			// ############################
			// something like...
			// srcCoords = [airports[flight.src].latitude, airports[flight.src].latitude]
			// destCoords = blah blah...
			// animateFlight(srcCoords, destCoords);
			fly(airports[flight.src],airports[flight.dest]);
		// Collect and display dest airport's spread Ratio
		for airport in airports:
			airport.spreadRatio = (airport.newInfected+airport.oldInfected)/airport.incoming
			// ##############################################
			// ##### DISPLAY SPREAD RATIO FOR AIRPORTS ######
			// ##############################################

			// Get people off planes into states
			states[airport.state].population += airport.incoming
			airport.incoming = 0
			states[airport.state].newInfected += airport.newInfected
			airport.newInfected = 0
			states[airport.state].oldinfected += airport.oldInfected
			airport.oldInfected = 0

		// ################################
		// ##### UPDATE STATE COLORS ######
		// ################################

		// Now take time to dissipate and spread disease
		for state in states:
			state.oldInfected += state.newInfected
			state.newInfected = r0*state.newInfected
		// ################################
		// ##### UPDATE STATE COLORS ######
		// ################################

	// ##############################################
	// ##### DISPLAY SPREAD RATIO FOR AIRPORTS ######
	// ##############################################



	</script>


</body>

<html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="//code.jquery.com/jquery-2.0.0.js"></script>
    <style>
    #map {
      background-color: #fff;
      border: 1px solid #ccc;
    }
    .background {
      fill: none;
      pointer-events: all;
    }
    #countries, #states {
      fill: #cde;
      stroke: #fff;
      stroke-linejoin: round;
      stroke-linecap: round;
    }
    #countries .active, #states .active {
      fill: #89a;
    }
    #cities {
      stroke-width: 0;
    }
    .city {
      fill: #345;
      stroke: #fff;
    }
    pre.prettyprint {
      border: 1px solid #ccc;
      margin-bottom: 0;
      padding: 9.5px;
    }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script>
    var m_width = $("#map").width(),
        width = 938,
        height = 500,
        country,
        state;

    var projection = d3.geo.mercator()
        .scale(150)
        .translate([width / 2, height / 1.5]);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("#map").append("svg")
        .attr("preserveAspectRatio", "xMidYMid")
        .attr("viewBox", "0 0 " + width + " " + height)
        .attr("width", m_width)
        .attr("height", m_width * height / width);

    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
        .on("click", country_clicked);

    var g = svg.append("g");

    d3.json("json/countries.topo.json", function(error, us) {
      g.append("g")
        .attr("id", "countries")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.countries).features)
        .enter()
        .append("path")
        .attr("id", function(d) { return d.id; })
        .attr("d", path)
        .on("click", country_clicked);
    });

    function zoom(xyz) {
      g.transition()
        .duration(750)
        .attr("transform", "translate(" + projection.translate() + ")scale(" + xyz[2] + ")translate(-" + xyz[0] + ",-" + xyz[1] + ")")
        .selectAll(["#countries", "#states", "#cities"])
        .style("stroke-width", 1.0 / xyz[2] + "px")
        .selectAll(".city")
        .attr("d", path.pointRadius(20.0 / xyz[2]));
    }

    function get_xyz(d) {
      var bounds = path.bounds(d);
      var w_scale = (bounds[1][0] - bounds[0][0]) / width;
      var h_scale = (bounds[1][1] - bounds[0][1]) / height;
      var z = .96 / Math.max(w_scale, h_scale);
      var x = (bounds[1][0] + bounds[0][0]) / 2;
      var y = (bounds[1][1] + bounds[0][1]) / 2 + (height / z / 6);
      return [x, y, z];
    }

    function country_clicked(d) {
      g.selectAll(["#states", "#cities"]).remove();
      state = null;

      if (country) {
        g.selectAll("#" + country.id).style('display', null);
      }

      if (d && country !== d) {
        var xyz = get_xyz(d);
        country = d;

        if (d.id  == 'USA' || d.id == 'JPN') {
		
			console.log(d);
			
          d3.json("json/states_" + d.id.toLowerCase() + ".topo.json", function(error, us) {
            g.append("g")
              .attr("id", "states")
              .selectAll("path")
              .data(topojson.feature(us, us.objects.states).features)
              .enter()
              .append("path")
              .attr("id", function(d) { return d.id; })
              .attr("class", "active")
              .attr("d", path)
              .on("click", state_clicked);

            zoom(xyz);
            g.selectAll("#" + d.id).style('display', 'none');
          });      
        } else {
          zoom(xyz);
        }
      } else {
        var xyz = [width / 2, height / 1.5, 1];
        country = null;
        zoom(xyz);
      }
    }

    function state_clicked(d) {
      g.selectAll("#cities").remove();

      if (d && state !== d) {
        var xyz = get_xyz(d);
        state = d;

        country_code = state.id.substring(0, 3).toLowerCase();
        state_name = state.properties.name;

        d3.json("json/cities_" + country_code + ".topo.json", function(error, us) {
          g.append("g")
            .attr("id", "cities")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.cities).features.filter(function(d) { return state_name == d.properties.state; }))
            .enter()
            .append("path")
            .attr("id", function(d) { return d.properties.name; })
            .attr("class", "city")
            .attr("d", path.pointRadius(20 / xyz[2]));

          zoom(xyz);
        });      
      } else {
        state = null;
        country_clicked(country);
      }
    }

    $(window).resize(function() {
      var w = $("#map").width();
      svg.attr("width", w);
      svg.attr("height", w * height / width);
    });
    </script>
  </body>
</html>
